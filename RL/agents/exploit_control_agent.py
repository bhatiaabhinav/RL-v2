import logging

import RL

logger = logging.getLogger(__name__)


class ExploitControlAgent(RL.Agent):
    """Sets the flag `should_exploit` based on `eval_mode`, `min_explore_steps`, and `exploit_freq`
    """
    def __init__(self, name, algo, eval_mode, min_explore_steps, exploit_freq):
        global logger
        logger = logging.getLogger(__name__)
        super().__init__(name, algo, supports_multiple_envs=False)
        self.eval_mode = eval_mode
        self.exploit_freq = exploit_freq
        self.min_explore_steps = min_explore_steps
        self._should_exploit = False

    @property
    def should_exploit(self):
        return self._should_exploit

    def pre_episode(self):
        if self.eval_mode:
            self._should_exploit = True
            logger.info("should_exploit=True because of eval_mode")
        else:
            if self.min_explore_steps is not None and self.manager.num_steps < self.min_explore_steps:
                logger.info(f"should_exploit=False because num_steps({self.manager.num_steps})<min_explore_steps({self.min_explore_steps}) and no eval_mode")
                self._should_exploit = False
            else:
                if self.exploit_freq is not None:
                    self._should_exploit = self.manager.num_episodes % self.exploit_freq == 0
                    logger.info(f"should_exploit={self._should_exploit} based on episode_id({self.manager.num_episodes}) and exploit_freq({self.exploit_freq}). No eval mode. min_explore_steps is None or expired.")
                else:
                    logger.info("should_exploit=False because no eval_mode, min_explore_steps None or expired, exploit_freq is None")
                    self._should_exploit = False
